<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, deleteDoc, addDoc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
      authDomain: "mandaleventall.firebaseapp.com",
      projectId: "mandaleventall",
      storageBucket: "mandaleventall.firebasestorage.app",
      messagingSenderId: "900190130114",
      appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
      measurementId: "G-2BBZZNRS88"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const mandals = ["‡§≠‡•á‡§Ç‡§∏‡•ã‡§¶‡§æ", "‡§≠‡§æ‡§®‡§™‡•Å‡§∞‡§æ", "‡§ó‡§∞‡•ã‡§†", "‡§Æ‡•á‡§≤‡§ñ‡•á‡§°‡§æ", "‡§ñ‡§°‡§º‡§æ‡§µ‡§¶‡§æ", "‡§∂‡§æ‡§Æ‡§ó‡•ù", "‡§∏‡•Å‡§µ‡§æ‡§∏‡§∞‡§æ", "‡§¨‡§∏‡§æ‡§à", "‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä", "‡§ï‡•ç‡§Ø‡§æ‡§Æ‡§™‡•Å‡§∞", "‡§∏‡•Ä‡§§‡§æ‡§Æ‡§ä ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§ó‡•Å‡§∞‡•ç‡§ú‡§∞ ‡§¨‡§∞‡§°‡§ø‡§Ø‡§æ", "‡§ß‡•Å‡§Ç‡§ß‡§ß‡•ú‡§ï‡§æ", "‡§¨‡•Å‡§¢‡§æ", "‡§™‡§ø‡§™‡§≤‡§ø‡§Ø‡§æ ‡§Æ‡§Ç‡§°‡•Ä", "‡§Æ‡§≤‡•ç‡§π‡§æ‡§∞‡§ó‡•ù", "‡§¶‡§≤‡•ã‡§¶‡§æ", "‡§Æ‡§ó‡§∞‡§æ‡§Æ‡§æ‡§§‡§æ ‡§ú‡•Ä", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§â‡§§‡•ç‡§§‡§∞", "‡§Æ‡§Ç‡§¶‡§∏‡•å‡§∞ ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£"];
    const eventNameMap = {};
    let eventPage = 1, coordPage = 1, reportPage = 1;
    const PAGE_SIZE = 21;

    window.addEventName = async function() {
      const newEventName = document.getElementById('newEventName').value.trim();
      if (!newEventName) return alert('‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡§ø‡§è!');
      await addDoc(collection(db, "eventNames"), { name: newEventName });
      document.getElementById('newEventName').value = '';
      setTimeout(async () => {
        await loadEventNames();
        await loadAll();
      }, 500);
      return;
      await loadEventNames();
      await loadAll();
    };

    async function loadEventNames() {
      const listInline = document.getElementById('eventNameListInline');
      listInline.innerHTML = '';
      const filterEvent = document.getElementById('filterEvent');
      filterEvent.innerHTML = `<option value="">‡§∏‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ</option>`;
      const snap = await getDocs(collection(db, "eventNames"));
      for (const docSnap of snap.docs) {
        const data = docSnap.data();
        eventNameMap[docSnap.id] = data.name || 'Unknown';
        const span = document.createElement('span');
        span.className = "event-inline-item";
        span.innerHTML = `
          <span>${data.name}</span>
          <button class="action-btn" style="font-size:1.1em;padding:2px 7px;" onclick="editEventNamePrompt('${docSnap.id}')">‚úèÔ∏è</button>
          <button class="action-btn delete" style="font-size:1.1em;padding:2px 7px;" onclick="deleteEventName('${docSnap.id}')">‚ùå</button>
        `;
        listInline.appendChild(span);
        const option = document.createElement('option');
        option.value = docSnap.id;
        option.textContent = data.name;
        filterEvent.appendChild(option);
      }
    }
    window.editEventNamePrompt = async function(eventNameId) {
      const current = eventNameMap[eventNameId] || '';
      const updated = prompt("‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç:", current);
      if (updated && updated.trim() && updated !== current) {
        await updateDoc(doc(db, "eventNames", eventNameId), { name: updated.trim() });
        await loadEventNames();
        await loadAll();
      }
    };
    window.deleteEventName = async function(eventNameId) {
      if (confirm("‡§á‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡•á ‡§∏‡•á ‡§∏‡§Æ‡•ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§∏‡§≠‡•Ä ‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§î‡§∞ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§≠‡•Ä ‡§π‡§ü ‡§ú‡§æ‡§Ø‡•á‡§Ç‡§ó‡•á!\n‡§™‡§ï‡•ç‡§ï‡§æ?")) {
        await deleteDoc(doc(db, "eventNames", eventNameId));
        await loadEventNames();
        await loadAll();
      }
    };

    const filterMandal = document.getElementById('filterMandal');
    mandals.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      filterMandal.appendChild(opt);
    });

    document.getElementById('filterEvent').addEventListener('change', function(){eventPage=1;coordPage=1;reportPage=1;loadAll();});
    document.getElementById('filterMandal').addEventListener('change', function(){eventPage=1;coordPage=1;reportPage=1;loadAll();});

    function switchTab(tabId) {
      ['eventsTab','coordinatorsTab','reportsTab'].forEach(id => {
        document.getElementById(id).classList.remove('active');
      });
      ['eventTabBtn','coordinatorTabBtn','reportTabBtn'].forEach(id=>{
        document.getElementById(id).classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      if(tabId==='eventsTab') document.getElementById('eventTabBtn').classList.add('active');
      else if(tabId==='coordinatorsTab') document.getElementById('coordinatorTabBtn').classList.add('active');
      else document.getElementById('reportTabBtn').classList.add('active');
    }
    window.switchTab = switchTab;

    async function loadEvents() {
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = '';
      document.getElementById('eventPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      const events = await getDocs(collection(db, "events"));
      let filtered = [];
      for (const docSnap of events.docs) {
        const event = docSnap.data();
        if (filterEventId && event.eventNameId !== filterEventId) continue;
        if (filterMandalVal && event.mandal !== filterMandalVal) continue;
        filtered.push({id: docSnap.id, ...event});
      }
      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (eventPage > totalPages) eventPage = totalPages;
      const pageEvents = filtered.slice((eventPage-1)*PAGE_SIZE, eventPage*PAGE_SIZE);
      for (const event of pageEvents) {
        let eventName = eventNameMap[event.eventNameId] || 'Unknown';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${eventName}</td>
          <td>${event.mandal || '-'}</td>
          <td>${event.date || '-'}</td>
          <td>${event.time || '-'}</td>
          <td>${event.location || '-'}</td>
          <td>
            <button class="action-btn" onclick="editEvent('${event.id}')">‚úèÔ∏è</button>
            <button class="action-btn delete" onclick="deleteEvent('${event.id}')">üóëÔ∏è</button>
          </td>
        `;
        eventList.appendChild(row);
      }
      document.getElementById('eventPagination').innerHTML = `
        <div class="pagination-controls" style="text-align:center">
          <button onclick="changeEventPage(-1)" ${eventPage==1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button>
          ${eventPage}/${totalPages}
          <button onclick="changeEventPage(1)" ${eventPage==totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>
        </div>`;
    }
    window.changeEventPage = function(diff) {
      eventPage += diff;
      loadEvents();
    };
    window.editEvent = async function(id) {
      const docSnap = await getDoc(doc(db, "events", id));
      if (!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
      const event = docSnap.data();
      const mandal = prompt("‡§Æ‡§Ç‡§°‡§≤:", event.mandal || "");
      const date = prompt("‡§§‡§æ‡§∞‡•Ä‡§ñ:", event.date || "");
      const time = prompt("‡§∏‡§Æ‡§Ø:", event.time || "");
      const location = prompt("‡§∏‡•ç‡§•‡§æ‡§®:", event.location || "");
      if (mandal !== null && date !== null && time !== null && location !== null) {
        await updateDoc(doc(db, "events", id), { mandal, date, time, location });
        await loadEvents();
      }
    };
    window.deleteEvent = async function(id) {
      if (confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")) {
        await deleteDoc(doc(db, "events", id));
        await loadEvents();
      }
    };

    async function loadCoordinators() {
      const coordinatorList = document.getElementById('coordinatorList');
      coordinatorList.innerHTML = '';
      document.getElementById('coordPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      let filtered = [];
      const eventNames = await getDocs(collection(db, "eventNames"));
      for (const eventNameDoc of eventNames.docs) {
        const eventNameId = eventNameDoc.id;
        if (filterEventId && eventNameId !== filterEventId) continue;
        const name = eventNameDoc.data().name || '';
        const coords = await getDocs(collection(db, `eventNames/${eventNameId}/coordinators`));
        for (const docSnap of coords.docs) {
          const c = docSnap.data();
          if (filterMandalVal && c.mandal !== filterMandalVal) continue;
          filtered.push({id: docSnap.id, eventNameId, name, ...c});
        }
      }
      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (coordPage > totalPages) coordPage = totalPages;
      const pageCoords = filtered.slice((coordPage-1)*PAGE_SIZE, coordPage*PAGE_SIZE);
      for (const c of pageCoords) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${c.name || ''}</td>
          <td>${c.mandal || '-'}</td>
          <td>${c.name || '-'}</td>
          <td>${c.mobile || '-'}</td>
          <td>${c.coCoordName1 || '-'}</td>
          <td>${c.coCoordMobile1 || '-'}</td>
          <td>${c.coCoordName2 || '-'}</td>
          <td>${c.coCoordMobile2 || '-'}</td>
          <td>
            <button class="action-btn" onclick="editCoordinator('${c.eventNameId}','${c.id}')">‚úèÔ∏è</button>
            <button class="action-btn delete" onclick="deleteCoordinator('${c.eventNameId}','${c.id}')">üóëÔ∏è</button>
          </td>
        `;
        coordinatorList.appendChild(row);
      }
      document.getElementById('coordPagination').innerHTML = `
        <div class="pagination-controls" style="text-align:center">
          <button onclick="changeCoordPage(-1)" ${coordPage==1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button>
          ${coordPage}/${totalPages}
          <button onclick="changeCoordPage(1)" ${coordPage==totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>
        </div>`;
    }
    window.changeCoordPage = function(diff) {
      coordPage += diff;
      loadCoordinators();
    };
    window.editCoordinator = async function(eventNameId, coordId) {
      const docSnap = await getDoc(doc(db, `eventNames/${eventNameId}/coordinators`, coordId));
      if (!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
      const c = docSnap.data();
      const mandal = prompt("‡§Æ‡§Ç‡§°‡§≤:", c.mandal || "");
      const name = prompt("‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï:", c.name || "");
      const mobile = prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤:", c.mobile || "");
      const coCoordName1 = prompt("‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 1:", c.coCoordName1 || "");
      const coCoordMobile1 = prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 1:", c.coCoordMobile1 || "");
      const coCoordName2 = prompt("‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï 2:", c.coCoordName2 || "");
      const coCoordMobile2 = prompt("‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 2:", c.coCoordMobile2 || "");
      if (mandal !== null && name !== null) {
        await updateDoc(doc(db, `eventNames/${eventNameId}/coordinators`, coordId), {
          mandal, name, mobile, coCoordName1, coCoordMobile1, coCoordName2, coCoordMobile2
        });
        await loadCoordinators();
      }
    };
    window.deleteCoordinator = async function(eventNameId, coordId) {
      if (confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")) {
        await deleteDoc(doc(db, `eventNames/${eventNameId}/coordinators`, coordId));
        await loadCoordinators();
      }
    };

    async function loadReports() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = '';
      document.getElementById('reportPagination').innerHTML = '';
      const filterEventId = document.getElementById('filterEvent').value;
      const filterMandalVal = document.getElementById('filterMandal').value;
      let filtered = [];
      const eventNames = await getDocs(collection(db, "eventNames"));
      for (const eventNameDoc of eventNames.docs) {
        const eventNameId = eventNameDoc.id;
        if (filterEventId && eventNameId !== filterEventId) continue;
        const name = eventNameDoc.data().name || '';
        const reports = await getDocs(collection(db, `eventNames/${eventNameId}/reports`));
        for (const docSnap of reports.docs) {
          const r = docSnap.data();
          if (filterMandalVal && r.mandal !== filterMandalVal) continue;
          filtered.push({id: docSnap.id, eventNameId, name, ...r});
        }
      }
      const reportedMandals = new Set(filtered.map(r => r.mandal));
      let pendingMandals = mandals.filter(m => !reportedMandals.has(m));
      if (document.getElementById('filterMandal').value) pendingMandals = [];
      document.getElementById('pendingMandals').innerText = pendingMandals.length ? `‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç: ${pendingMandals.join(", ")}` : '';

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (reportPage > totalPages) reportPage = totalPages;
      const pageReports = filtered.slice((reportPage-1)*PAGE_SIZE, reportPage*PAGE_SIZE);

      for (const r of pageReports) {
        let photosHTML = "";
        if (Array.isArray(r.photos)) {
          let photosToShow = r.photos.slice(0,6);
          photosHTML = `<div class="report-photos-grid">` +
            photosToShow.map(url =>
              `<img src="${url}" onclick="zoomImage(event, '${url}')">`
            ).join('') +
            `</div>`;
        }
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${r.name}</td>
          <td>${r.mandal || '-'}</td>
          <td>${r.location || '-'}</td>
          <td>${r.date || '-'}</td>
          <td>${r.attendance || '-'}</td>
          <td>${r.guests || '-'}</td>
          <td>${r.details || '-'}</td>
          <td>${photosHTML}</td>
          <td>
            <button class="action-btn" onclick="editReport('${r.eventNameId}','${r.id}')">‚úèÔ∏è</button>
            <button class="action-btn delete" onclick="deleteReport('${r.eventNameId}','${r.id}')">üóëÔ∏è</button>
          </td>
        `;
        reportList.appendChild(row);
      }
      document.getElementById('reportPagination').innerHTML = `
        <div class="pagination-controls" style="text-align:center">
          <button onclick="changeReportPage(-1)" ${reportPage==1?'disabled':''}>‡§™‡§ø‡§õ‡§≤‡§æ</button>
          ${reportPage}/${totalPages}
          <button onclick="changeReportPage(1)" ${reportPage==totalPages?'disabled':''}>‡§Ö‡§ó‡§≤‡§æ</button>
        </div>`;
    }
    window.changeReportPage = function(diff) {
      reportPage += diff;
      loadReports();
    };
    window.editReport = async function(eventNameId, reportId) {
      const docSnap = await getDoc(doc(db, `eventNames/${eventNameId}/reports`, reportId));
      if (!docSnap.exists()) return alert("‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
      const r = docSnap.data();
      const mandal = prompt("‡§Æ‡§Ç‡§°‡§≤:", r.mandal || "");
      const location = prompt("‡§∏‡•ç‡§•‡§æ‡§®:", r.location || "");
      const date = prompt("‡§§‡§æ‡§∞‡•Ä‡§ñ:", r.date || "");
      const attendance = prompt("‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø:", r.attendance || "");
      const guests = prompt("‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø:", r.guests || "");
      const details = prompt("‡§µ‡§ø‡§µ‡§∞‡§£:", r.details || "");
      if (mandal !== null && location !== null) {
        await updateDoc(doc(db, `eventNames/${eventNameId}/reports`, reportId), {
          mandal, location, date, attendance, guests, details
        });
        await loadReports();
      }
    };
    window.deleteReport = async function(eventNameId, reportId) {
      if (confirm("‡§™‡§ï‡•ç‡§ï‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§π‡•à?")) {
        await deleteDoc(doc(db, `eventNames/${eventNameId}/reports`, reportId));
        await loadReports();
      }
    };

    window.zoomImage = function(e, url) {
      e.preventDefault();
      document.getElementById('imgZoomModalImg').src = url;
      document.getElementById('imgZoomModal').style.display = 'flex';
    };
    document.getElementById('imgZoomModal').onclick = function() {
      this.style.display = 'none';
      document.getElementById('imgZoomModalImg').src = '';
    };

    async function loadAll() {
      await loadEventNames();
      await loadEvents();
      await loadCoordinators();
      await loadReports();
    }
    loadAll();
  </script>
<script>
    window.exportEvents = function(type) {
      const table = document.querySelector('#eventsTab table');
      exportTableData(table, type, "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä");
    };
    window.exportCoordinators = function(type) {
      const table = document.querySelector('#coordinatorsTab table');
      exportTableData(table, type, "‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä");
    };
    window.exportReports = function(type) {
      const table = document.querySelector('#reportsTab table');
      exportTableData(table, type, "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä");
    };
    function exportTableData(table, type, title) {
      const rows = Array.from(table.querySelectorAll('tr'));
      const data = rows.map(row => Array.from(row.children).map(cell => cell.innerText));
      if (!data.length) return alert("‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
      if (type === 'csv' || type === 'excel') {
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, title);
        if (type === 'csv') XLSX.writeFile(wb, `${title}.csv`);
        else XLSX.writeFile(wb, `${title}.xlsx`);
      }
      if (type === 'pdf') {
        const doc = new jspdf.jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
        doc.addFileToVFS("NotoSansDevanagari-Regular-normal.ttf", window.NotoSansDevanagariNormal);
        doc.addFont("NotoSansDevanagari-Regular-normal.ttf", "NotoSansDevanagari", "normal");
        doc.setFont("NotoSansDevanagari");
        doc.setFontSize(14);
        doc.text(title, 40, 40, {lang: "hi"});
        doc.autoTable({
          startY: 60,
          head: [data[0]],
          body: data.slice(1),
          styles: { font: "NotoSansDevanagari", fontSize: 12 },
          headStyles: {fillColor:[255,152,0]},
          bodyStyles: {textColor:30}
        });
        doc.save(`${title}.pdf`);
      }
    }
    window.exportCombinedTable = function(type="excel") {
      const masterHeader = [
        "‡§°‡•á‡§ü‡§æ ‡§∏‡•ç‡§∞‡•ã‡§§", "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§®‡§æ‡§Æ", "‡§Æ‡§Ç‡§°‡§≤", "‡§§‡§æ‡§∞‡•Ä‡§ñ", "‡§∏‡§Æ‡§Ø", "‡§∏‡•ç‡§•‡§æ‡§®",
        "‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï", "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤", "‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï1", "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤1", "‡§∏‡§π-‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï2", "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤2",
        "‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø", "‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ö‡§§‡§ø‡§•‡§ø", "‡§µ‡§ø‡§µ‡§∞‡§£"
      ];
      let allRows = [masterHeader];
      document.querySelectorAll("#eventList tr").forEach(tr => {
        const tds = [...tr.querySelectorAll("td")];
        if(tds.length) allRows.push([
          "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•Ç‡§ö‡•Ä", tds[0]?.innerText||"", tds[1]?.innerText||"", tds[2]?.innerText||"", tds[3]?.innerText||"", tds[4]?.innerText||"",
          "", "", "", "", "", "", "", "", ""
        ]);
      });
      document.querySelectorAll("#coordinatorList tr").forEach(tr => {
        const tds = [...tr.querySelectorAll("td")];
        if(tds.length) allRows.push([
          "‡§∏‡§Ç‡§Ø‡•ã‡§ú‡§ï ‡§∏‡•Ç‡§ö‡•Ä", tds[0]?.innerText||"", tds[1]?.innerText||"", "", "", "",
          tds[2]?.innerText||"", tds[3]?.innerText||"",
          tds[4]?.innerText||"", tds[5]?.innerText||"",
          tds[6]?.innerText||"", tds[7]?.innerText||"",
          "", ""
        ]);
      });
      document.querySelectorAll("#reportList tr").forEach(tr => {
        const tds = [...tr.querySelectorAll("td")];
        if(tds.length) allRows.push([
          "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡•Ç‡§ö‡•Ä", tds[0]?.innerText||"", tds[1]?.innerText||"", tds[3]?.innerText||"", "", tds[2]?.innerText||"",
          "", "", "", "", "", "",
          tds[4]?.innerText||"", tds[5]?.innerText||"", tds[6]?.innerText||""
        ]);
      });
      if(type==="csv" || type==="excel") {
        const ws = XLSX.utils.aoa_to_sheet(allRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "AllData");
        if(type==="csv") XLSX.writeFile(wb, "AllData.csv");
        else XLSX.writeFile(wb, "AllData.xlsx");
      }
      else if(type==="pdf") {
        const doc = new jspdf.jsPDF({orientation:'landscape',unit:'pt',format:'a4'});
        doc.addFileToVFS("NotoSansDevanagari-Regular-normal.ttf", window.NotoSansDevanagariNormal);
        doc.addFont("NotoSansDevanagari-Regular-normal.ttf", "NotoSansDevanagari", "normal");
        doc.setFont("NotoSansDevanagari");
        doc.setFontSize(14);
        doc.text("‡§Æ‡§Ç‡§°‡§≤ ‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü", 40, 40, {lang: "hi"});
        doc.autoTable({
          startY: 60,
          head: [masterHeader],
          body: allRows.slice(1),
          styles: { font: "NotoSansDevanagari", fontSize: 10 },
          headStyles: {fillColor:[255,152,0]},
          bodyStyles: {textColor:30}
        });
        doc.save("AllData.pdf");
      }
    };
    window.handleExport = function() {
      const value = document.getElementById('exportDropdown').value;
      if (!value) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç!");
      // JPG Download
      if (value.endsWith("-jpg")) {
        let selector = "";
        if (value.startsWith("reports-")) selector = "#reportsTab";
        else if (value.startsWith("events-")) selector = "#eventsTab";
        else if (value.startsWith("coordinators-")) selector = "#coordinatorsTab";
        else selector = ".container";
        exportSectionAsJPG(selector, "Dashboard-" + Date.now());
        return;
      }
      
    window.updateReportCell = async function(eventNameId, reportId, field, value) {
      const ref = doc(db, `eventNames/${eventNameId}/reports`, reportId);
      await updateDoc(ref, { [field]: value });
      console.log(`Updated ${field} = ${value}`);
    };
    

    window.updateReportCell = async function(eventNameId, reportId, field, value) {
      const ref = doc(db, `eventNames/${eventNameId}/reports`, reportId);
      await updateDoc(ref, { [field]: value });
      console.log(`Updated ${field} = ${value}`);
    };

// ‡§¨‡§æ‡§ï‡•Ä ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü
      if (value.startsWith("combined-")) {
        const type = value.split("-")[1];
        exportCombinedTable(type);
      } else if (value.startsWith("events-")) {
        const type = value.split("-")[1];
        exportEvents(type);
      } else if (value.startsWith("coordinators-")) {
        const type = value.split("-")[1];
        exportCoordinators(type);
      } else if (value.startsWith("reports-")) {
        const type = value.split("-")[1];
        exportReports(type);
      }
    };
    function exportSectionAsJPG(selector, fileName="Dashboard") {
      const section = document.querySelector(selector);
      if(!section) return alert("‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
      html2canvas(section, {backgroundColor:"#fff", useCORS: true, allowTaint: true}).then(canvas => {
        let link = document.createElement("a");
        link.href = canvas.toDataURL("image/jpeg", 1.0);
        link.download = fileName+".jpg";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }
  </script>