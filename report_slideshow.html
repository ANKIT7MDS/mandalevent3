<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>मंडल में सम्पन्न हुए विभिन्न संगठनात्मक कार्यक्रम</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f4f6fa;
            font-family: 'Noto Sans Devanagari', Arial, sans-serif;
            color: #1c2942; margin: 0; padding: 0;
        }
        .container-tv {
            max-width: 1380px; margin: 12px auto 8px auto;
            background: #fff; border-radius: 18px; box-shadow: 0 4px 24px #e6a74912;
            padding: 12px 2vw 20px 2vw; position: relative;
        }
        .tv-title-bar {
            display: flex; align-items: center; border-bottom: 3px solid #ff9800;
            padding-bottom: 6px; margin-bottom: 10px; gap: 12px;
        }
        .tv-logo { width: 46px; height: 46px; min-width: 46px; background: linear-gradient(120deg,#ffe1b9,#ffc46d); border:2.5px solid #fff3e0; border-radius:50%; font-weight:700; font-size:1.25rem; color:#e65100; display:flex;align-items:center;justify-content:center;}
        .tv-title-main { font-size: 1.28rem; font-weight: 700; color: #263b64; white-space: normal; word-break: break-word; max-width: 82vw;}
        .tv-pagination {margin-left:auto;font-size:1.07rem;font-weight:600;color:#b78937;}
        .tv-controls {
            display: flex;justify-content:center;gap:8px;margin:18px 0 0 0;flex-wrap:wrap;
        }
        .tv-controls button {
            background:#ff9800;color:#fff;font-weight:600;border:none;
            border-radius:7px;padding:7px 18px;font-size:1rem;cursor:pointer;
            transition:background 0.12s;letter-spacing:.5px;
        }
        .tv-controls .autoplay-btn {background:#1976d2;}
        .tv-controls .autoplay-btn.active {background:#44a62c;}
        .tv-controls .pdf-btn {background:#5e35b1;}
        .tv-controls .pdf-btn:hover {background:#4527a0;}
        .slideshow-section {
            display: flex; flex-direction: row; gap: 28px; margin-bottom: 12px;
            align-items: flex-start; min-height: 440px;
        }
        .slide-card {
            background:#f8fafc; border-radius:14px; box-shadow:0 2px 16px #ffe9d72a; padding:19px 22px 14px 18px; min-width:320px; flex:1 1 58%; max-width:700px;
        }
        .slide-title { font-size:1.18rem; font-weight:700; color:#d07011; margin-bottom:9px;}
        .slide-details-row { font-size:1.09rem; margin:4px 0;}
        .slide-details-row span {color:#77530e;font-weight:500;min-width:74px;display:inline-block;}
        .slide-description {font-size:1.07rem; margin:13px 0 2px 0; color:#212427; line-height:1.48;}
        /* -- PHOTO SLIDER/GRID -- */
        .photo-slider-box {
            background:#fffaf3; border-radius:16px; box-shadow:0 2px 10px #ffe9d744;
            padding:18px 10px 12px 10px; min-width: 340px; max-width: 440px; flex: 0 0 32%;
            display:flex;flex-direction:column;align-items:center;position:relative;
        }
        .slider-title-bar {font-size:1.08rem;font-weight:700;color:#d07011;margin-bottom:10px;border-left:4px solid #ff9800;padding-left:12px;align-self:flex-start;}
        .gallery-switcher {
            display: flex; gap: 10px; justify-content: center; 
            margin: 9px 0 5px 0; width: 100%;
        }
        .gallery-switch-btn {
            background: #eee; color: #555; font-weight: 600; border: none;
            border-radius: 7px; padding: 4px 15px; font-size: 1rem; cursor: pointer; 
            transition: background 0.18s; min-width: 90px;
        }
        .gallery-switch-btn.active { background: #ff9800; color: #fff;}
        @media (max-width:700px) {.gallery-switcher {display:none;}}
        /* -- slider -- */
        .slider-photo-frame {
            position:relative; width:100%; aspect-ratio:4/2.6; min-height:220px; max-height:310px; overflow:hidden; border-radius:14px; background:#eee;
            display: flex; align-items: center; justify-content: center;
        }
        .slider-photo-frame img {
            width:100%; height:100%; object-fit:cover; border-radius:14px; background:#fff; display:block;
            transition:opacity 0.4s cubic-bezier(.65,.04,.35,1),transform 0.4s cubic-bezier(.65,.04,.35,1);
        }
        .slider-photo-frame .no-photo {
            width:100%;height:100%;display:flex;align-items:center;justify-content:center;
            color:#bbb;font-size:2.2rem;font-weight:600;
            background: repeating-linear-gradient(135deg,#eee 0 10px,#fff 10px 20px);
        }
        .slider-arrow {
            position:absolute;top:50%;transform:translateY(-50%);
            background:#ff9800bb;color:#fff;font-size:1.9rem;font-weight:700;border:none;border-radius:50%;
            width:38px;height:38px;display:flex;align-items:center;justify-content:center;
            box-shadow:0 1px 12px #ff98004c;cursor:pointer;z-index:20;
            transition:background 0.13s;
        }
        .slider-arrow:hover {background:#f37804;}
        .slider-arrow.left {left:6px;}
        .slider-arrow.right {right:6px;}
        .slider-dots {margin:10px 0 0 0;display:flex;gap:9px;justify-content:center;}
        .slider-dot {width:13px;height:13px;border-radius:50%;background:#ddd;transition:background 0.19s; border:2px solid #fff;cursor:pointer;}
        .slider-dot.active {background:#ff9800;}
        /* -- grid -- */
        .gallery-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 13px 12px;}
        .gallery-img-box {position:relative; border-radius:10px; overflow:hidden; aspect-ratio:4/3; background:#fff; min-width:0; height: 140px; min-height: 90px; max-height: 200px;}
        .gallery-img-box img {width:100%;height:100%;object-fit:cover;object-position:center center;border-radius:10px;display:block;background:#fff;cursor:pointer;position:absolute;left:0;top:0;touch-action:none;}
        @media (max-width:700px) {
            .slideshow-section {flex-direction:column;}
            .slide-card {max-width:99vw;}
            .photo-slider-box {max-width:99vw;min-width:0;margin-top:14px;}
            .slider-title-bar {padding-left:6px;}
            .slider-photo-frame {aspect-ratio:4/3;min-height:115px;}
            .slider-dot {width:11px;height:11px;}
            .gallery-grid .gallery-img-box {height: 25vw; min-height: 85px;}
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/iamdual/jsPDF-NotoSansDevanagari/dist/NotoSansDevanagari.js"></script>
</head>
<body>
<div class="container-tv">
    <div class="tv-title-bar">
        <div class="tv-logo">BJ</div>
        <div class="tv-title-main">मंडल में सम्पन्न हुए विभिन्न संगठनात्मक कार्यक्रम</div>
        <div class="tv-pagination" id="tv-pagination">1 / 1</div>
    </div>
    <div class="slideshow-section" id="tv-slideshow"></div>
    <div class="tv-controls">
        <button onclick="prevSlide()">&#8592; पिछला</button>
        <button onclick="nextSlide()">अगला &#8594;</button>
        <button class="autoplay-btn" id="autoplayBtn" onclick="toggleAutoplay()">टीवी-मोड</button>
        <button class="pdf-btn" onclick="downloadPDF()">PDF</button>
    </div>
</div>
<!-- फोटो Zoom Modal -->
<div id="imgZoomModal" style="display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.87);align-items:center;justify-content:center;">
    <img id="imgZoomModalImg" src="">
</div>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
const firebaseConfig = {
    apiKey: "AIzaSyCI1EL8iFVJnOWbd58Bq5JrJg_IgZuCvA0",
    authDomain: "mandaleventall.firebaseapp.com",
    projectId: "mandaleventall",
    storageBucket: "mandaleventall.firebasestorage.app",
    messagingSenderId: "900190130114",
    appId: "1:900190130114:web:bc7d9e2283b3ac57bc505b",
    measurementId: "G-2BBZZNRS88"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let reports = [];
let slideIndex = 0;
let autoplay = false, autoplayInterval = null;
let photoIdx = 0, photoPlay = false, photoTimer = null;
let galleryView = "slide"; // desktop: "slide" | "grid", mobile: always "grid"

async function loadReports() {
    const eventNamesSnap = await getDocs(collection(db, "eventNames"));
    const eventNames = {};
    eventNamesSnap.forEach(docSnap => {
        eventNames[docSnap.id] = docSnap.data().name || '';
    });
    let allReports = [];
    for (const eventNameId of Object.keys(eventNames)) {
        const reportSnap = await getDocs(collection(db, `eventNames/${eventNameId}/reports`));
        reportSnap.forEach(docSnap => {
            const r = docSnap.data();
            let photoOffsets = Array.isArray(r.photoOffsets) ? r.photoOffsets : [];
            allReports.push({
                ...r,
                id: docSnap.id,
                eventNameId,
                eventName: eventNames[eventNameId],
                photoOffsets
            });
        });
    }
    allReports.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    reports = allReports;
    showSlide(0);
}
window.prevSlide = function() {
    if (!reports.length) return;
    slideIndex = (slideIndex-1+reports.length) % reports.length;
    showSlide(slideIndex);
}
window.nextSlide = function() {
    if (!reports.length) return;
    slideIndex = (slideIndex+1)%reports.length;
    showSlide(slideIndex);
}
window.toggleAutoplay = function() {
    autoplay = !autoplay;
    let btn = document.getElementById('autoplayBtn');
    btn.classList.toggle('active', autoplay);
    btn.textContent = autoplay ? "टीवी-मोड बंद करें" : "टीवी-मोड";
    if (autoplay) {
        autoplayInterval = setInterval(() => {
            nextSlide();
        }, 4000);
    } else {
        clearInterval(autoplayInterval);
    }
}
// -------- गैलरी व्यू टॉगल --------
function showGallerySwitcher(photos) {
    if(window.innerWidth <= 700) return '';
    let slideBtn = `<button class="gallery-switch-btn${galleryView=='slide'?' active':''}" onclick="setGalleryView('slide')">स्लाइड व्यू</button>`;
    let gridBtn = `<button class="gallery-switch-btn${galleryView=='grid'?' active':''}" onclick="setGalleryView('grid')">ग्रिड व्यू</button>`;
    if(photos.length<2) return ''; // switcher की जरूरत नहीं
    return `<div class="gallery-switcher">${slideBtn}${gridBtn}</div>`;
}
window.setGalleryView = function(mode) {
    galleryView = mode;
    showSlide(slideIndex, false);
}
// फुल slide और grid दोनों implement:
function showGallery(photos, eventIdx) {
    // --- mobile: हमेशा grid ---
    if(window.innerWidth <= 700 || galleryView === "grid") {
        let showPhotos = [];
        for(let i=0;i<4;i++) showPhotos.push(photos[i] ? photos[i] : "https://dummyimage.com/600x450/eee/aaa&text=No+Photo");
        let gridHtml = `<div class="gallery-grid">`;
        showPhotos.forEach((url, pidx) => {
            gridHtml += `
            <div class="gallery-img-box">
                <img src="${url}" alt="कार्यक्रम फोटो" onclick="zoomImage(event, '${url}')">
            </div>`;
        });
        gridHtml += `</div>`;
        return gridHtml;
    }
    // --- desktop: slide view ---
    let curr = Math.max(0, Math.min(photoIdx, photos.length-1));
    let img = photos[curr] ? 
        `<img src="${photos[curr]}" alt="कार्यक्रम फोटो" onclick="zoomImage(event, '${photos[curr]}')" style="opacity:1;">`
        : `<div class="no-photo">No Photo</div>`;
    let arrows = '';
    if (photos.length>1) {
        arrows = `
            <button class="slider-arrow left" onclick="photoPrev(event)">&larr;</button>
            <button class="slider-arrow right" onclick="photoNext(event)">&rarr;</button>
        `;
    }
    let dots = `<div class="slider-dots">`;
    for(let i=0;i<photos.length;i++){
        dots += `<div class="slider-dot${i===curr?' active':''}" onclick="photoGoto(${i})"></div>`;
    }
    dots += `</div>`;
    return `<div class="slider-photo-frame">${arrows}${img}</div>${dots}`;
}
// फोटो स्लाइडर कंट्रोल्स
window.photoPrev = function(e){
    e.stopPropagation();
    if(!reports[slideIndex]) return;
    let photos = Array.isArray(reports[slideIndex].photos)?reports[slideIndex].photos:[];
    photoIdx = (photoIdx-1+photos.length)%photos.length;
    showSlide(slideIndex,false);
}
window.photoNext = function(e){
    e.stopPropagation();
    if(!reports[slideIndex]) return;
    let photos = Array.isArray(reports[slideIndex].photos)?reports[slideIndex].photos:[];
    photoIdx = (photoIdx+1)%photos.length;
    showSlide(slideIndex,false);
}
window.photoGoto = function(idx){
    photoIdx = idx;
    showSlide(slideIndex,false);
}
function startPhotoAutoPlay(photos) {
    if(photoTimer) clearInterval(photoTimer);
    if(!photos || photos.length<2) return;
    photoPlay = true;
    photoTimer = setInterval(()=>{
        photoIdx = (photoIdx+1)%photos.length;
        showSlide(slideIndex,false);
    },2600);
}
function stopPhotoAutoPlay() {
    if(photoTimer) clearInterval(photoTimer);
    photoPlay = false;
}
function showSlide(idx, resetPhoto=true) {
    if (!reports.length) {
        document.getElementById('tv-slideshow').innerHTML = `<div style="color:#d07a1a;font-size:1.2rem;">कोई रिपोर्ट डेटा उपलब्ध नहीं है।</div>`;
        document.getElementById('tv-pagination').innerText = "";
        return;
    }
    slideIndex = idx;
    const r = reports[idx];
    if(resetPhoto) photoIdx=0;
    let detailsHtml = `
    <div class="slide-card">
        <div class="slide-title">${r.eventName || 'कार्यक्रम'}</div>
        <div class="slide-details">
            <div class="slide-details-row"><span>तारीख:</span> ${r.date || '-'}</div>
            <div class="slide-details-row"><span>स्थान:</span> ${r.location || '-'}</div>
            <div class="slide-details-row"><span>मंडल:</span> ${r.mandal || '-'}</div>
            <div class="slide-details-row"><span>प्रकार:</span> ${r.type || (r.prakar||'कार्यक्रम')}</div>
            <div class="slide-details-row"><span>उपस्थिति:</span> ${r.attendance || '-'}</div>
            <div class="slide-details-row"><span>अतिथि:</span> ${r.guests || '-'}</div>
        </div>
        <div class="slide-description">${(r.details||'').replace(/\n/g,'<br>')}</div>
        ${r.hashtag ? `<div class="slide-details-row" style="margin-top:7px;color:#4a7dc0;">#${r.hashtag}</div>` : ''}
    </div>
    `;
    let photos = Array.isArray(r.photos) ? r.photos : [];
    let gallery = `<div class="photo-slider-box">
        <div class="slider-title-bar">फोटो गैलरी</div>
        ${showGallery(photos, idx)}
        ${showGallerySwitcher(photos)}
    </div>`;
    document.getElementById('tv-slideshow').innerHTML = detailsHtml + gallery;
    document.getElementById('tv-pagination').innerText = `${idx+1} / ${reports.length}`;
    // Autoplay logic
    if(window.innerWidth>700 && galleryView==="slide" && photos.length>1){
        stopPhotoAutoPlay();
        startPhotoAutoPlay(photos);
    } else {
        stopPhotoAutoPlay();
    }
}
// responsive: window size change पर view बदलो
window.addEventListener('resize', ()=>{
    if(window.innerWidth <= 700 && galleryView!=="grid"){
        galleryView="grid"; showSlide(slideIndex, false);
    }
    if(window.innerWidth > 700 && galleryView!=="slide"){
        galleryView="slide"; showSlide(slideIndex, false);
    }
});
window.zoomImage = function(e, url) {
    e.preventDefault();
    document.getElementById('imgZoomModalImg').src = url;
    document.getElementById('imgZoomModal').style.display = 'flex';
};
document.getElementById('imgZoomModal').onclick = function() {
    this.style.display = 'none';
    document.getElementById('imgZoomModalImg').src = '';
};
// PDF (Same as before, use first photo)
window.downloadPDF = function() {
    if (!reports[slideIndex]) return;
    let r = reports[slideIndex];
    const doc = new jspdf.jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
    doc.addFileToVFS("NotoSansDevanagari-Regular-normal.ttf", window.NotoSansDevanagariNormal);
    doc.addFont("NotoSansDevanagari-Regular-normal.ttf", "NotoSansDevanagari", "normal");
    doc.setFont("NotoSansDevanagari");
    doc.setFontSize(19);
    doc.text(r.eventName || 'कार्यक्रम', 45, 44, {lang:"hi"});
    doc.setFontSize(13);
    let y = 72;
    let details = [
        ["तारीख", r.date||'-'], ["स्थान", r.location||'-'], ["मंडल", r.mandal||'-'],
        ["प्रकार", r.type||(r.prakar||'कार्यक्रम')], ["उपस्थिति", r.attendance||'-'],
        ["अतिथि", r.guests||'-']
    ];
    doc.autoTable({
        startY: y, head:[["फील्ड", "विवरण"]], body: details,
        styles:{ font:"NotoSansDevanagari", fontSize:13 }
    });
    y = doc.lastAutoTable.finalY + 18;
    doc.text("कार्यक्रम विवरण:", 45, y, {lang:"hi"});
    y+=19;
    let desc = (r.details||'-').replace(/\n/g," ");
    doc.text(desc, 55, y, {maxWidth:720,lang:"hi"});
    let photos = (Array.isArray(r.photos)?r.photos:[]).slice(0,1);
    let imgY = y+33;
    if(photos.length){
        let img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
            doc.addImage(img, "JPEG", 60, imgY, 260, 180);
            doc.save((r.eventName||'report')+".pdf");
        };
        img.onerror = function() { doc.save((r.eventName||'report')+".pdf"); };
        img.src = photos[0];
    } else {
        doc.save((r.eventName||'report')+".pdf");
    }
};
loadReports();
</script>
</body>
</html>
